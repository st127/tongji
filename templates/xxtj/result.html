{% extends 'xxtj/base.html' %}
{% block head %}
    <script type="text/javascript">
    var xmlhttp = false;
    function createRequest(url, dothing) {
        if (window.XMLHttpRequest) {
            xmlhttp = new XMLHttpRequest();
            if(xmlhttp.overrideMimeType){
                xmlhttp.overrideMimeType("text/xml");
            }
        } else if(window.ActiveXObject) {
            try{
                xmlhttp = new ActiveXObject("Msxml2.XMLHTTP");
            }catch (e) {
                try {
                    xmlhttp = new ActiveXObject("Microsoft.XMLHTTP")
                }catch (e) {}
            }
        }
        if(!xmlhttp){
            alert("不能创建xmlhttp实例，请不要使用兼容模式或更换浏览器！")
            return false;
        }
        if(dothing === "get_sta_inf"){
            xmlhttp.onreadystatechange = get_sta_inf;
        }
        else if(dothing === "clear_response"){
            xmlhttp.onreadystatechange = clear_response_;
        }
        else if(dothing === "check_token"){
            xmlhttp.onreadystatechange = check_token;
        }
        xmlhttp.open("GET", url, true);
        xmlhttp.send(null);
    }
    function get_sta_inf() {
        var return_obj;
        var statistical;
        var unstatistical;
        var i;
        statistical="<table class='table'>";
        unstatistical="<table class='table'>";
        if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
            return_obj = JSON.parse(xmlhttp.responseText);
            document.getElementById("description").innerHTML=return_obj.description;
            for (i = 1; i <= return_obj.l_sta; i++){
                statistical = statistical + return_obj.statistical[i];
            }
            statistical = statistical + "</table>"
            document.getElementById("statistical").innerHTML=statistical;

            for (i = 1; i <= return_obj.l_unsta; i++){
                unstatistical = unstatistical + return_obj.unstatistical[i];
            }
            unstatistical = unstatistical + "</table>"
            document.getElementById("unstatistical").innerHTML=unstatistical;
        }
    }
    function clear_response_() {
        var return_obj;
        if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
            return_obj = JSON.parse(xmlhttp.responseText);
            if (return_obj.status === "success") {
                alert("数据清除成功！");
                location.reload();
            }
        }
    }
    function query(str) {
        if(str === "0"){
            alert("请选择项目");
            return false;
        }
        createRequest("{% url 'xxtj:ajax' %}?statistics=" + str + "&do=get_result_by_sta", "get_sta_inf");
    }
    function clear_() {
        var statistics=document.getElementById("statistics").value;
        if(statistics === "0"){
            alert("请选择项目");
            return false;
        }
        createRequest("{% url 'xxtj:ajax' %}?statistics= " + statistics + "&do=clear_sta", "clear_response");
    }
    function add_description() {
        window.location.href="{% url 'xxtj:result'%}" + "?admin_id={{ admin_id }}&do=add_description";
    }
    function setCookie(cname, cvalue, exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        var expires = "expires="+ d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        {#document.cookie = cname + "=" + cvalue + ";" + ";path=/";#}
    }
    function getCookie(cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for(var i = 0; i <ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
             }
             if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
             }
         }
        return "";
    }
    function getQueryVariable(variable){
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i=0;i<vars.length;i++) {
                var pair = vars[i].split("=");
                if(pair[0] == variable){return pair[1];}
        }
        return(false);
    }
    function advanced() {
        var token;
        if (getQueryVariable("admin_id") != false) {
            if ((token = getCookie("token")) != "") {
                createRequest("{% url 'xxtj:ajax' %}?do=check_login_token&admin_id={{ admin_id }}&token=" + token, "check_token")
            }
            else{
                alert("请先登录");
                window.location.href="{% url 'advance:login' %}?admin_id={{ admin_id }}&goto=result_advanced";
            }
        }
    }
    function check_token() {
        var return_obj;
        if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
            return_obj = JSON.parse(xmlhttp.responseText);
            if(return_obj.status === "true"){
                setCookie("admin_id", "{{ admin_id }}", 365)
                window.location.href="{% url 'advance:index'%}";
            }
        }
    }
</script>
{% endblock head %}
{% block base %}
    <table align="center">
        <tr>
            <td><span style="font-size: 36px; font-family: Georgia, 'Times New Roman',
            Times, serif; font-weight: bold; text-align: center;">信息统计结果</span></td>
        </tr>
    </table>
    <table width="90%" class="table table-bordered">
        <tr>
            <td width="30%"><h4><strong>选择项目</strong></h4></td>
            <td>
                <select name="statistics" onchange="query(this.value)" id="statistics" class="form-control">
                    <option value="0"></option>
                    {% for key, value in statistics.items %}
                        <option value="{{ key }}">{{ value }}</option>
                    {% endfor %}
                </select>
            </td>
        </tr>
        <tr>
            <td><h4><strong>说明</strong></h4></td>
            <td><div id="description"></div></td>
        </tr>
        <tr>
            <td><h4><strong>已提交</strong></h4></td>
            <td><div id="statistical"></div></td>
        </tr>
        <tr>
            <td><h4><strong>未提交</strong></h4></td>
            <td><div id="unstatistical"></div></td>
        </tr>
        <tr>
            <td colspan="2">
                <button onclick="clear_()" class="btn btn-warning">清除数据并开始下一次统计</button>
                <button onclick="add_description()" class="btn btn-default">添加/修改说明</button>
            </td>
        </tr>
        <tr>
            <td colspan="2">
                <button onclick="advanced()" class="btn btn-default">高级选项</button>
            </td>
        </tr>
    </table>
{% endblock base %}